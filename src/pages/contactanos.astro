---
import Layout from "../layouts/Layout.astro";
import CountryPhoneSelector from "../components/index/CountryPhoneSelector.vue";
import { Icon } from "astro-icon/components";
import "intl-tel-input/build/css/intlTelInput.css";

const googleMapsEmbedUrl =
  "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3901.543945156077!2d-86.17760532576695!3d12.074867988164163!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x8f73f8ccad74f691%3A0x408e99da01b92314!2sResidencial%20Casa%20Blanca%2C%20Valle%20Gotel!5e0!3m2!1ses-419!2sni!4v1751409835766!5m2!1ses-419!2sn";
---

<Layout>
  <div class="flex flex-col gap-8 px-4 pt-8 sm:px-6 md:px-10 lg:px-20 xl:px-40">
    <div id="result" class="hidden" role="alert" tabindex="0">
      <svg
        class="h-4 w-4 shrink-0"
        aria-hidden="true"
        xmlns="http://www.w3.org/2000/svg"
        fill="currentColor"
        viewBox="0 0 20 20"
      >
        <path
          d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"
        ></path>
      </svg>
      <span class="sr-only">Info</span>
      <div class="ms-3 text-sm font-medium" id="alertText"></div>
      <button
        type="button"
        class="-mx-1.5 -my-1.5 ms-auto inline-flex h-8 w-8 items-center justify-center rounded-lg bg-blue-50 p-1.5 text-blue-500 hover:bg-blue-200 focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:text-blue-400 dark:hover:bg-gray-800"
        data-dismiss-target="#alert-1"
        aria-label="Close"
      >
        <span class="sr-only">Close</span>
        <svg
          class="h-3 w-3"
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 14 14"
        >
          <path
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"></path>
        </svg>
      </button>
    </div>

    <h1 class="text-3xl font-bold sm:text-4xl">Contáctanos</h1>

    <!-- Two columns on desktop -->
    <div class="flex flex-col gap-12 lg:flex-row">
      <!-- FORM SECTION -->
      <div class="flex-1">
        <p class="pb-4 text-base">
          Si te ha interesado alguno de nuestros modelos o servicios puedes
          llenar el formulario que te proporcionamos a continuación para que uno
          de nuestros agentes se ponga en contacto contigo.
        </p>
        <hr />
        <form
          class="flex w-full flex-col gap-4"
          method="POST"
          name="contactForm"
          id="contactForm"
          action="https://api.web3forms.com/submit"
        >
          <input
            type="hidden"
            name="access_key"
            value="67aa6cb2-fbc5-4b21-8a84-eb0e3d205930"
          />
          <fieldset class="flex w-full flex-col gap-4">
            <legend class="text-lg font-semibold text-white"
              >Información de contacto</legend
            >

            <label for="name" class="text-white">Nombre:</label>
            <input
              type="text"
              id="name"
              name="name"
              placeholder="e.j. Juan José López Pérez"
              class="w-full rounded p-2"
              required
            />

            <!-- Email + Phone Responsive -->
            <div class="flex w-full flex-col gap-4 md:flex-row">
              <div class="flex w-full flex-col gap-2">
                <label for="email" class="text-white">Email:</label>
                <input
                  type="email"
                  name="email"
                  id="email"
                  placeholder="e.j. ejemplo@email.com"
                  class="w-full rounded p-2"
                  required
                />
              </div>

              <div class="flex w-full flex-col gap-2">
                <label for="countryPhone" class="text-white"
                  >Número de teléfono:</label
                >
                <CountryPhoneSelector
                  client:visible
                  class="phone-input-wrapper w-full"
                  id="countryPhone"
                />

                <input
                  type="hidden"
                  value="+505"
                  name="extension"
                  id="extension"
                  required
                />
                <div class="mt-2 flex items-center gap-2">
                  <input
                    type="checkbox"
                    name="hasWhatsapp"
                    id="hasWhatsapp"
                    class="rounded-2xl border-2 border-white text-gray-700"
                  />
                  <label for="hasWhatsapp" class="text-white"
                    >¿Posee Whatsapp?</label
                  >
                </div>
              </div>
            </div>

            <!-- Consultation Info -->
            <fieldset class="mb-2 flex w-full flex-col gap-2">
              <legend class="text-lg font-semibold text-white"
                >Información de la consulta:</legend
              >

              <label for="category" class="text-white"
                >Categoría de la consulta:</label
              >
              <select
                name="category"
                id="category"
                class="w-full rounded p-2"
                required
              >
                <option disabled selected>-- Elige una categoría --</option>
                <option value="Casas">Casas</option>
                <option value="Modelos Tebas">Modelos Tebas</option>
                <option value="Modelos Blok-on">Modelos Blok-on</option>
                <option value="Otros servicios">Otros servicios</option>
                <option value="Consulta General/Otros temas"
                  >Consulta General/Otros temas</option
                >
              </select>

              <label for="message" class="text-white">Consulta:</label>
              <textarea
                id="message"
                name="message"
                rows="6"
                placeholder="Buenas tardes, quería hacer una pregunta con respecto..."
                class="w-full rounded p-2"
                required></textarea>
            </fieldset>
          </fieldset>

          <div class="h-captcha" data-captcha="true" data-lang="es"></div>

          <input
            type="checkbox"
            name="botcheck"
            class="hidden"
            style="display: none;"
          />

          <button
            class="w-fit rounded bg-cyan-600 px-6 py-3 font-semibold text-white transition-colors hover:cursor-pointer hover:bg-cyan-700"
            role="button"
            type="submit"
            id="submitButton"
          >
            Enviar
          </button>
        </form>
      </div>

      <!-- SIDEBAR SECTION -->
      <aside class="flex flex-1 flex-col gap-6">
        <h2 class="text-xl font-bold sm:text-2xl">
          Puedes escribirnos en nuestras redes sociales
        </h2>

        <ul class="flex gap-4 text-3xl">
          <li>
            <a
              href="https://www.facebook.com/share/19bHFMUjYo/"
              aria-label="Facebook"
              class="hover:text-tebas-400 transition-colors"
              target="_blank"
              rel="noopener noreferrer"
              role="button"
            >
              <Icon name="ic:baseline-facebook" />
            </a>
          </li>
          <li>
            <a
              href="https://www.tiktok.com/@construccion.grupotebas"
              aria-label="TikTok"
              class="hover:text-tebas-400 transition-colors"
              target="_blank"
              rel="noopener noreferrer"
              role="button"
            >
              <Icon name="ic:baseline-tiktok" />
            </a>
          </li>
          <li>
            <a
              href="https://www.instagram.com/grupo_tebas/"
              aria-label="Instagram"
              class="hover:text-tebas-400 transition-colors"
              target="_blank"
              rel="noopener noreferrer"
              role="button"
            >
              <Icon name="mdi:instagram" />
            </a>
          </li>
          <li>
            <a
              href="https://wa.me/+50577988555?text=Buenas tardes, estoy aquí por la página web ¿Podría compartirme el cátalogo de modelos?"
              aria-label="WhatsApp"
              class="hover:text-tebas-400 transition-colors"
              target="_blank"
              rel="noopener noreferrer"
              role="button"
            >
              <Icon name="ic:baseline-whatsapp" />
            </a>
          </li>
        </ul>

        <p>
          O puedes visitarnos en Km. 14 Carretera a Masaya, 4 kilómetros hacia
          Veracruz. Residencial Casa Blanca, casa b7.
        </p>

        <div
          class="h-64 w-full overflow-hidden rounded shadow-lg sm:h-80 md:h-96 lg:h-[450px]"
        >
          <iframe
            title="Mapa de google maps con la dirección Km. 14 Carretera a Masaya, 4 kilómetros hacia Veracruz. Residencial Casa Blanca, casa b7"
            src={googleMapsEmbedUrl}
            class="h-full w-full rounded"
            allowfullscreen
            loading="lazy"
            style="border: 0"
            referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
      </aside>
    </div>
  </div>
</Layout>

<style>
  .phone-input-wrapper {
    --iti-dialcode-color: var(--color-gray-600);
  }
</style>

<script>
  const error =
    "flex items-center p-4 mb-4 text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400";
  const success =
    "flex items-center p-4 mb-4 text-green-800 rounded-lg bg-green-50 dark:bg-gray-800 dark:text-green-400";

  document.addEventListener("DOMContentLoaded", () => {
    try {
      const result = document.getElementById("result");
      if (result === null) {
        throw new Error("Result was not Found");
      }
      const alertText = document.getElementById("alertText");
      if (alertText === null) {
        throw new Error("Alert Text was not Found.");
      }

      const submitButton = document.getElementById(
        "submitButton",
      ) as HTMLButtonElement;
      if (submitButton === null) {
        throw new Error("Submit Button was not Found.");
      }

      const contactForm = document.getElementById(
        "contactForm",
      ) as HTMLFormElement;
      if (contactForm === null) {
        result.classList = error;
        alertText.innerText =
          "Error: El formulario de contacto no fue encontrado.";
        throw new Error("Contact Form was not Found.");
      }

      contactForm.addEventListener("submit", (e) => {
        e.preventDefault();

        if (!contactForm.checkValidity()) {
          (
            contactForm.querySelectorAll(":invalid")[0] as HTMLInputElement
          ).focus();
          return;
        }

        const hCaptcha = contactForm.querySelector(
          "textarea[name=h-captcha-response]",
        );
        if (hCaptcha === null) {
          throw new Error("Contact Form was not Found.");
        }

        if (!(hCaptcha as HTMLInputElement).value) {
          e.preventDefault();
          result.classList = error;
          alertText.innerText =
            "Por favor completa el captcha antes de enviar el formulario.";
          result.focus();

          return;
        }

        const formData = new FormData(contactForm);
        const object = Object.fromEntries(formData);

        if (object.botcheck) {
          result.classList = error;
          alertText.innerText = "¿Qué te pasó botsito? 🤖";
          result.focus();
          return;
        }

        const name = object.name.toString();
        const email = object.email.toString();
        const extension = object.extension.toString();
        const phone = parseInt(object.phone.toString());

        let hasWhatsapp = false;
        if (object.hasWhatsapp) {
          hasWhatsapp = true;
        }

        const category = object.category.toString();
        const message = object.message.toString();
        const accessKey = object.access_key.toString();

        sendContactForm(
          name,
          email,
          extension,
          phone,
          hasWhatsapp,
          category,
          message,
          accessKey,
        )
          .then(async (response) => {
            if (response.status === 200) {
              result.classList = success;
              alertText.innerText =
                "¡Mensaje enviado correctamente!, nuestro equipo de ventas se estará contactando contigo pronto.";
              result.focus();
              return;
            }
            const json = await response.json();

            result.classList = error;
            alertText.innerText = json.message;
            result.focus();
          })
          .catch((error) => {
            console.log(error);
            result.classList = error;
            result.innerHTML = "Something went wrong!";
            result.focus();
          });

        contactForm.reset();
        setTimeout(() => {
          result.classList = "hidden";
        }, 5000);
      });
    } catch (e) {
      console.error(e);
    }
  });

  const sendContactForm = async (
    name: string,
    email: string,
    extension: string,
    phone: number,
    hasWhatsapp: boolean,
    category: string,
    message: string,
    accessKey: string,
  ) => {
    const body: Object = {
      Nombre: name,
      Email: email,
      Extension: extension,
      Teléfono: phone,
      "¿Tiene Whatsapp?": hasWhatsapp ? "Sí" : "No",
      "Categoría de la consulta": category,
      Mensaje: message,
      access_key: accessKey,
    };

    const bodyString: string = JSON.stringify(body);

    const response = await fetch("https://api.web3forms.com/submit", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: bodyString,
    });
    return response;
  };
</script>
